<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Quest Log"/>
<title>Quest Log</title>

<script>
(function(){
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><linearGradient id="bg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FF8C00"/><stop offset="100%" stop-color="#FFD700"/></linearGradient></defs><rect width="512" height="512" rx="115" fill="url(#bg)"/><rect x="120" y="148" width="272" height="44" rx="22" fill="rgba(255,255,255,0.9)"/><rect x="120" y="234" width="200" height="44" rx="22" fill="rgba(255,255,255,0.7)"/><rect x="120" y="320" width="232" height="44" rx="22" fill="rgba(255,255,255,0.7)"/><circle cx="96" cy="170" r="22" fill="white"/><circle cx="96" cy="256" r="22" fill="rgba(255,255,255,0.5)"/><circle cx="96" cy="342" r="22" fill="rgba(255,255,255,0.5)"/><polyline points="84,170 93,180 112,158" stroke="#FF8C00" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`;
  const enc='data:image/svg+xml,'+encodeURIComponent(svg);
  const m={name:"Quest Log",short_name:"Quest",start_url:"./",display:"standalone",background_color:"#0a0e1a",theme_color:"#F4A000",icons:[{src:enc,sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}]};
  const link=document.createElement("link");link.rel="manifest";link.href=URL.createObjectURL(new Blob([JSON.stringify(m)],{type:"application/json"}));document.head.appendChild(link);
  const ai=document.createElement("link");ai.rel="apple-touch-icon";ai.href=enc;document.head.appendChild(ai);
  const tc=document.createElement("meta");tc.name="theme-color";tc.content="#F4A000";document.head.appendChild(tc);
})();
</script>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>

<style>
/* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
:root{
  --or:#E8930A;--or2:#FF8C00;--org:rgba(232,147,10,.3);--ors:rgba(232,147,10,.1);
  --bg:#EEF1F8;--bg2:#FFFFFF;--bg3:#E4E8F2;
  --panel:#FFFFFF;--panel2:#F5F7FC;
  --tx:#1A1F35;--tx2:#5A6480;--tx3:#9BA3BB;
  --bd:rgba(232,147,10,.3);--bd2:rgba(26,31,53,.08);--bd3:rgba(26,31,53,.04);
  --gr:#00B894;--rd:#E84460;--bl:#2563EB;
  --sh:0 2px 12px rgba(0,0,0,.07);--sh2:0 6px 32px rgba(0,0,0,.1);--sho:0 4px 20px rgba(232,147,10,.22);
  --r:12px;--rs:8px;
}
[data-theme=dark]{
  --bg:#0A0E1A;--bg2:#0D1220;--bg3:#111827;
  --panel:#0F1628;--panel2:#131c30;
  --tx:#E8EAF0;--tx2:#8899AA;--tx3:#3a4f65;
  --bd:rgba(232,147,10,.25);--bd2:rgba(255,255,255,.06);--bd3:rgba(255,255,255,.03);
  --sh:0 2px 12px rgba(0,0,0,.4);--sh2:0 6px 32px rgba(0,0,0,.5);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);font-family:'Barlow',sans-serif;color:var(--tx);-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}

/* ‚îÄ‚îÄ CLIP PATHS ‚îÄ‚îÄ */
.cc{clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))}
.ccs{clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,6px 100%,0 calc(100% - 6px))}
.hex{clip-path:polygon(50% 0%,95% 25%,95% 75%,50% 100%,5% 75%,5% 25%);display:flex;align-items:center;justify-content:center}

/* ‚îÄ‚îÄ XP BAR ‚îÄ‚îÄ */
.xpf{height:100%;background:linear-gradient(90deg,#FF6B00,#F4A000,#FFD700);position:relative;overflow:hidden;box-shadow:0 0 10px rgba(244,160,0,.4);transition:width 1s cubic-bezier(.34,1.56,.64,1)}
.xpf::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);animation:shim 2.5s infinite}
@keyframes shim{to{left:200%}}

/* ‚îÄ‚îÄ QUEST ROW ‚îÄ‚îÄ */
.qrow{display:flex;margin-bottom:6px;cursor:pointer;transition:transform .15s;-webkit-tap-highlight-color:transparent}
.qrow:active{transform:scale(.99)}
.qi{display:flex;align-items:center;gap:12px;width:100%;padding:13px 16px;background:var(--panel);border:1px solid var(--bd2);box-shadow:var(--sh);clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));transition:all .2s}
.qrow:hover .qi{background:var(--ors);border-color:var(--bd);box-shadow:var(--sho)}
.qrow.done .qi{background:var(--panel2);border-color:var(--bd3);box-shadow:none}
.qrow.done .qt{text-decoration:line-through;color:var(--tx3)}
.chk{width:27px;height:27px;flex-shrink:0;background:var(--bg3);border:2px solid var(--bd);clip-path:polygon(15% 0%,85% 0%,100% 15%,100% 85%,85% 100%,15% 100%,0% 85%,0% 15%);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;transition:all .25s;color:transparent}
.chk.on{background:linear-gradient(135deg,#FF6B00,#F4A000);border-color:transparent;box-shadow:0 0 14px rgba(244,160,0,.5);color:#fff}
.pop{animation:pk .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes pk{0%{transform:scale(1)}45%{transform:scale(1.04)}100%{transform:scale(1)}}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:1px;text-transform:uppercase;border:none;cursor:pointer;transition:all .18s;-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden}
.btn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);transition:.18s}
.btn:hover::after{background:rgba(255,255,255,.1)}
.btn-ow{background:linear-gradient(135deg,#C47800,#F4A000,#FFB300);color:#fff;padding:10px 22px;font-size:13px;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);box-shadow:0 4px 16px rgba(244,160,0,.3);text-shadow:0 1px 2px rgba(0,0,0,.25)}
.btn-ow:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(244,160,0,.45)}
.btn-ow:active{transform:translateY(0)}
.btn-ow:disabled{opacity:.4;transform:none;cursor:not-allowed}
.btn-gh{background:var(--panel);color:var(--tx2);border:1px solid var(--bd2);padding:9px 16px;font-size:12px;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);box-shadow:var(--sh)}
.btn-gh:hover{color:var(--tx);border-color:var(--bd)}
.btn-rd{background:rgba(232,68,96,.08);color:var(--rd);border:1px solid rgba(232,68,96,.22);padding:9px 16px;font-size:12px;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%)}
.btn-rd:hover{background:rgba(232,68,96,.15)}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.inp{background:var(--bg3);border:1px solid var(--bd2);color:var(--tx);font-family:'Barlow',sans-serif;font-size:14px;padding:11px 14px;width:100%;outline:none;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
.inp:focus{border-color:var(--or);box-shadow:0 0 0 3px var(--ors)}
.inp::placeholder{color:var(--tx3)}
select.inp{appearance:none}
select.inp option{background:var(--bg2);color:var(--tx)}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;background:var(--bd2);outline:none;cursor:pointer;clip-path:none;border:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%);background:linear-gradient(135deg,#FF6B00,#F4A000);cursor:pointer}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;z-index:400;padding:20px;animation:fi .2s ease}
@keyframes fi{from{opacity:0}}
.modal{background:var(--panel);border:1px solid var(--bd);clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px));padding:28px;width:100%;max-width:440px;box-shadow:var(--sh2),0 0 60px rgba(244,160,0,.1);animation:su .3s cubic-bezier(.34,1.56,.64,1);max-height:90vh;overflow-y:auto}
@keyframes su{from{transform:translateY(24px);opacity:0}}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:500;pointer-events:none;display:none}
#toast.in{display:block;animation:tin .4s cubic-bezier(.34,1.56,.64,1) forwards}
#toast.out{animation:tout .35s ease forwards}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(-18px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes tout{from{opacity:1;transform:translateX(-50%) translateY(0)}to{opacity:0;transform:translateX(-50%) translateY(-14px)}}
.toast-pill{background:linear-gradient(135deg,rgba(255,107,0,.97),rgba(244,160,0,.97));backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.25);border-radius:50px;padding:12px 26px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 40px rgba(244,160,0,.45),0 0 80px rgba(244,160,0,.15);white-space:nowrap}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--panel);border:1px solid var(--bd2);border-radius:var(--r);box-shadow:var(--sh);padding:18px 20px}.chart-lg{min-height:100px}
.stat-c{flex:1;background:var(--panel);border:1px solid var(--bd2);box-shadow:var(--sh);padding:13px 8px;text-align:center;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))}
.hcard{background:var(--panel);border:1px solid var(--bd2);box-shadow:var(--sh);clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px));padding:14px 16px;margin-bottom:8px}
.rwcard{display:flex;align-items:center;gap:12px;padding:13px 16px;margin-bottom:8px;border:1px solid;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));transition:all .2s}
.rwcard.locked{background:var(--panel2);border-color:var(--bd3)}
.rwcard.unlocked{background:var(--ors);border-color:var(--bd);box-shadow:var(--sho);animation:gp 2.5s ease-in-out infinite}
.rwcard.claimed{background:rgba(0,184,148,.07);border-color:rgba(0,184,148,.28)}
@keyframes gp{0%,100%{box-shadow:0 0 0 rgba(244,160,0,.1)}50%{box-shadow:0 0 20px rgba(244,160,0,.22)}}

/* ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ */
.slbl{font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;font-size:10px;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.slbl::before{content:'';width:12px;height:2px;background:linear-gradient(90deg,var(--or),transparent);display:block}
.snum{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;line-height:1}

/* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
.tog{width:44px;height:24px;border-radius:12px;background:var(--bd2);border:1px solid var(--bd2);cursor:pointer;position:relative;transition:background .3s;flex-shrink:0}
.tog.dk{background:linear-gradient(135deg,#1E3A5F,#0d1220);border-color:var(--bd)}
.tog::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,#FF8C00,#F4A000);transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 2px 6px rgba(0,0,0,.2)}
.tog.dk::after{transform:translateX(20px)}

/* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
.setup{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:14px;background:var(--bg)}
.step-box{background:var(--panel);border:1px solid var(--bd2);border-radius:var(--r);box-shadow:var(--sh);padding:18px 22px;width:100%;max-width:520px;transition:border-color .2s}
.step-box:hover{border-color:var(--bd)}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.snav{display:flex;align-items:center;gap:10px;padding:11px 14px;background:none;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;color:var(--tx3);cursor:pointer;transition:all .18s;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);width:100%;text-align:left;-webkit-tap-highlight-color:transparent}
.snav.on{color:#fff;background:linear-gradient(135deg,#C47800,#F4A000)}
.snav:not(.on):hover{background:var(--ors);color:var(--or)}
.mtab{flex:1;padding:10px 3px;background:none;border:none;border-top:2px solid transparent;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--tx3);cursor:pointer;transition:all .18s;-webkit-tap-highlight-color:transparent}
.mtab.on{color:var(--or);border-top-color:var(--or)}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.bdg{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.5px}
.bdg-or{background:var(--ors);color:var(--or);border:1px solid rgba(232,147,10,.2)}
.bdg-gr{background:rgba(0,184,148,.1);color:var(--gr);border:1px solid rgba(0,184,148,.2)}
.bdg-bl{background:rgba(37,99,235,.1);color:var(--bl);border:1px solid rgba(37,99,235,.15)}

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.div{display:flex;align-items:center;gap:10px;margin:16px 0 10px}
.div::before,.div::after{content:'';flex:1;height:1px;background:var(--bd2)}
.divl{font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:2px;color:var(--tx3)}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.tag{font-size:11px;padding:2px 8px;font-family:'Barlow Condensed',sans-serif;display:inline-block;margin:2px 3px 2px 0}
.spin{width:16px;height:16px;border:2px solid var(--bd);border-top-color:var(--or);border-radius:50%;animation:sp .7s linear infinite;display:inline-block}
@keyframes sp{to{transform:rotate(360deg)}}
.ping{width:6px;height:6px;border-radius:50%;background:var(--gr);display:inline-block;margin-right:5px;animation:pa 2s ease-in-out infinite}
@keyframes pa{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,184,148,.5)}50%{opacity:.5;box-shadow:0 0 0 5px rgba(0,184,148,0)}}
.errbar{background:rgba(232,68,96,.07);border:1px solid rgba(232,68,96,.2);border-radius:var(--rs);padding:10px 14px;font-size:12px;color:var(--rd);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.grad-text{background:linear-gradient(135deg,#FF8C00,#F4A000,#FFD700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{min-height:100vh}
.layout{display:grid;grid-template-columns:200px 1fr 460px;grid-template-rows:100vh;min-height:100vh}
.sl{background:var(--bg2);border-right:1px solid var(--bd2);padding:22px 14px;overflow-y:auto;display:flex;flex-direction:column;transition:background .3s}
.mc{overflow-y:auto;padding:28px 30px;background:var(--bg);transition:background .3s}
.sr{background:var(--bg2);border-left:1px solid var(--bd2);padding:22px 18px;overflow-y:auto;transition:background .3s}
.mob-nav{display:none}
.mob-head{display:none}
@media(max-width:1300px){.layout{grid-template-columns:190px 1fr 380px}}@media(max-width:1000px){.layout{grid-template-columns:190px 1fr 300px}}@media(max-width:860px){.layout{grid-template-columns:190px 1fr}.sr{display:none}}
@media(max-width:767px){
  .layout{display:block}
  .sl,.sr{display:none}
  .mc{padding:14px;padding-bottom:80px;min-height:100vh}
  .mob-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--bd2);z-index:100;padding-bottom:env(safe-area-inset-bottom,0px)}
  .mob-head{display:block;margin-bottom:14px}
}
</style>
</head>
<body>
<div id="app"></div>
<div id="toast"></div>

<script>
'use strict';
/* ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ */
const TODAY=()=>{
  const d=new Date();
  d.setTime(d.getTime()+9*60*60*1000);
  return d.toISOString().slice(0,10);
};
const LS_URL="ql-url",LS_THEME="ql-theme",LS_TITLE="ql-title";
// XP curve: Ï¥àÎ∞ò Îπ†Î¶Ñ(1~5), Ï§ëÎ∞ò ÏôÑÎßå(6~15), ÌõÑÎ∞ò ÎèÑÏ†ÑÏ†Å(16+)
// Lv1: 200, Lv5: ~800, Lv10: ~2200, Lv20: ~7000, Lv30: ~16000
const XPL=lv=>{
  if(lv<=5)  return Math.floor(200*Math.pow(lv,1.3));
  if(lv<=15) return Math.floor(180*Math.pow(lv,1.65));
  return Math.floor(150*Math.pow(lv,1.9));
};
function getLv(xp){let lv=1,acc=0;while(true){const n=XPL(lv);if(acc+n>xp)return{level:lv,cur:xp-acc,need:n,pct:((xp-acc)/n)*100};acc+=n;lv++;}}
const CAT={"ÎßàÏù∏Îìú":{color:"#7B68EE"},"Î∞îÎîî":{color:"#00B894"},"ÏÑ±Ïû•":{color:"#F4A000"},"Ïª§Ïä§ÌÖÄ":{color:"#E84460"}};
// Í∏∞Î≥∏ ÌÄòÏä§Ìä∏ XP ÏÑ§Í≥Ñ:
// - Ïâ¨ÏõÄ(5~10Î∂Ñ, ÏäµÍ¥ÄÏÑ±): 35~50 XP
// - Î≥¥ÌÜµ(15~30Î∂Ñ, ÎÖ∏Î†•ÌïÑÏöî): 80~120 XP
// - Ïñ¥Î†§ÏõÄ(ÏßëÏ§ëÎ†•/ÏßÄÏÜçÏÑ±): 130~160 XP
// Îç∞ÏùºÎ¶¨ ÌíÄ ÏôÑÎ£å Ïãú Ï¥ù ~730 XP
const DQ=[
  {id:"q1",title:"Ïä§Ìä∏Î†àÏπ≠ 10Î∂Ñ",       category:"Î∞îÎîî",  emoji:"ü§∏",xp:45, active:true},
  {id:"q2",title:"Ïö¥Îèô 30Î∂Ñ",            category:"Î∞îÎîî",  emoji:"üí™",xp:120,active:true},
  {id:"q3",title:"ÎèÖÏÑú 20ÌéòÏù¥ÏßÄ",        category:"ÏÑ±Ïû•",  emoji:"üìö",xp:100,active:true},
  {id:"q4",title:"Î¨º 2L ÎßàÏãúÍ∏∞",         category:"Î∞îÎîî",  emoji:"üíß",xp:35, active:true},
  {id:"q5",title:"Ï†ÄÎÑêÎßÅ 10Î∂Ñ",          category:"ÎßàÏù∏Îìú",emoji:"üìì",xp:55, active:true},
  {id:"q6",title:"Í≤åÏûÑ Í∏∞Ìöç Í≥µÎ∂Ä",       category:"ÏÑ±Ïû•",  emoji:"üéÆ",xp:130,active:true},
  {id:"q7",title:"Ï∑®ÏóÖ Ï§ÄÎπÑ ÌôúÎèô",       category:"ÏÑ±Ïû•",  emoji:"üíº",xp:140,active:true},
  {id:"q8",title:"Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í≥†ÎèÑÌôî",    category:"ÏÑ±Ïû•",  emoji:"üóÇÔ∏è",xp:160,active:true},
];
// Î≥¥ÏÉÅ ÏÑ§Í≥Ñ Ï≤†Ìïô:
// - Ï¥àÎ∞ò(1~5): 2Î†àÎ≤®ÎßàÎã§ Ïπ≠Ìò∏ ‚Üí Îπ†Î•∏ ÏÑ±Ï∑®Í∞ê
// - Ï§ëÎ∞ò(6~15): ÌòÑÏã§Î≥¥ÏÉÅ + Ïπ≠Ìò∏ ÍµêÏ∞® ‚Üí ÏßÄÏÜç ÎèôÍ∏∞
// - ÌõÑÎ∞ò(16+): Ìù¨Í∑Ä Ïπ≠Ìò∏ + ÌÅ∞ Î≥¥ÏÉÅ ‚Üí Ïû•Í∏∞ Î™©Ìëú
// Ïπ≠Ìò∏ ÏÑúÏÇ¨: Ïã†ÏûÖ ‚Üí Í∞ÅÏÑ± ‚Üí Ï†ÑÏÇ¨ ‚Üí ÏòÅÏõÖ ‚Üí Ï†ÑÏÑ§ ‚Üí Ïã†Ìôî
const DR=[
  {level:2, type:"title",value:"üå± Ï≤´ Î∞úÍ±∏Ïùå",         claimed:false},
  {level:3, type:"real", value:"Ï¢ãÏïÑÌïòÎäî Ïπ¥Ìéò Î∞©Î¨∏ ‚òï",  claimed:false},
  {level:5, type:"title",value:"‚ö° Í∞ÅÏÑ±Ïûê",              claimed:false},
  {level:6, type:"real", value:"ÏπòÌÇ® or ÌîºÏûê Ìïú Ìåê üçó",  claimed:false},
  {level:8, type:"title",value:"üî• ÏùòÏßÄÏùò Ï†ÑÏÇ¨",         claimed:false},
  {level:10,type:"real", value:"ÏõêÌïòÎäî Î¨ºÍ±¥ Íµ¨Îß§ üõçÔ∏è",   claimed:false},
  {level:12,type:"title",value:"üíé ÏäµÍ¥ÄÏùò Í≤∞Ï†ïÏ≤¥",        claimed:false},
  {level:15,type:"real", value:"ÌäπÎ≥ÑÌïú Ïô∏Ïãù or Í≥µÏó∞ üé≠",  claimed:false},
  {level:18,type:"title",value:"üåü ÏûêÍ∏∞ Í∑πÎ≥µÏûê",          claimed:false},
  {level:20,type:"real", value:"ÏõêÌïòÎäî Ïó¨Ìñâ Í≥ÑÌöç ‚úàÔ∏è",    claimed:false},
  {level:25,type:"title",value:"üëë Î£®Ìã¥Ïùò Íµ∞Ï£º",          claimed:false},
  {level:30,type:"real", value:"ÎÇòÎßåÏùò ÌäπÎ≥Ñ Î≥¥ÏÉÅ üèÜ",     claimed:false},
  {level:35,type:"title",value:"üî± Ï†ÑÏÑ§Ïùò Í≤ΩÏßÄ",          claimed:false},
  {level:50,type:"title",value:"‚öúÔ∏è Î∂àÎ©∏Ïùò Ï°¥Ïû¨",          claimed:false},
];

/* ‚îÄ‚îÄ JSONP ‚îÄ‚îÄ */
function jsonp(url,params){
  return new Promise((res,rej)=>{
    const cb="jcb_"+Math.random().toString(36).slice(2);
    const s=document.createElement("script");
    const t=setTimeout(()=>{cleanup();rej(new Error("Timeout"));},15000);
    function cleanup(){clearTimeout(t);delete window[cb];s.parentNode&&s.parentNode.removeChild(s);}
    window[cb]=data=>{cleanup();res(data);};
    const p={};
    for(const[k,v]of Object.entries(params))p[k]=(typeof v==="object"&&v!==null)?JSON.stringify(v):String(v);
    s.src=url+"?"+new URLSearchParams({...p,callback:cb});
    s.onerror=()=>{cleanup();rej(new Error("Network error ‚Äî URLÍ≥º Î∞∞Ìè¨ ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî."));};
    document.head.appendChild(s);
  });
}

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
const S={
  view:"setup",tab:"today",
  sheetsUrl:localStorage.getItem(LS_URL)||"",
  theme:localStorage.getItem(LS_THEME)||"light",
  activeTitle:localStorage.getItem(LS_TITLE)||"",
  quests:DQ,dailyLogs:{},rewards:DR,profile:{totalXP:0},
  loading:false,syncing:false,syncErr:"",
  modal:null,form:{},popId:null,
};
document.documentElement.setAttribute("data-theme",S.theme);

let _raf=false;
function setState(p){
  Object.assign(S,typeof p==="function"?p(S):p);
  if(!_raf){_raf=true;requestAnimationFrame(()=>{_raf=false;render();});}
}

/* ‚îÄ‚îÄ THEME ‚îÄ‚îÄ */
function toggleTheme(){
  const n=S.theme==="light"?"dark":"light";
  S.theme=n;document.documentElement.setAttribute("data-theme",n);
  localStorage.setItem(LS_THEME,n);render();
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let _toastTimer=null;
function showToast(lv){
  const el=document.getElementById("toast");
  if(!el)return;
  if(_toastTimer)clearTimeout(_toastTimer);
  el.className="in";
  const title=S.activeTitle?`<span style="color:rgba(255,255,255,.85);font-size:12px">${S.activeTitle}</span>`:"";
  el.innerHTML=`<div class="toast-pill"><span style="font-size:22px">üéä</span><div><div style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:17px;color:#fff;letter-spacing:2px">LEVEL UP ‚Üí LV.${lv}</div>${title}</div></div>`;
  _toastTimer=setTimeout(()=>{el.className="out";setTimeout(()=>{el.className="";el.innerHTML="";},350);},3000);
}

/* ‚îÄ‚îÄ API ‚îÄ‚îÄ */
async function loadAll(){
  setState({loading:true,syncErr:""});
  try{
    const d=await jsonp(S.sheetsUrl,{action:"getAll"});
    if(d.error)throw new Error(d.error);
    // Normalize date keys to YYYY-MM-DD
const rawLogs=d.dailyLogs||{};
const normLogs={};
for(const[k,v]of Object.entries(rawLogs)){
  let key=k;
  // If not already YYYY-MM-DD, parse and convert
  if(!/^\d{4}-\d{2}-\d{2}$/.test(k)){
    const dt=new Date(k);
    if(!isNaN(dt.getTime())){
      dt.setTime(dt.getTime()+9*60*60*1000);
      key=dt.toISOString().slice(0,10);
    }
  }
  // Merge if key collision
  if(normLogs[key]){
    const ex=normLogs[key];
    const merged={...v.completed,...ex.completed};
    normLogs[key]={completed:merged,bonusQuests:[...(v.bonusQuests||[]),...(ex.bonusQuests||[])]};
  } else {
    normLogs[key]=v;
  }
}
setState({quests:d.quests||DQ,dailyLogs:normLogs,rewards:d.rewards||DR,profile:d.profile||{totalXP:0},view:"app",loading:false});
    localStorage.setItem(LS_URL,S.sheetsUrl);
  }catch(e){setState({loading:false,syncErr:e.message});}
}
async function sh(p){
  setState({syncing:true});
  try{await jsonp(S.sheetsUrl,p);}catch(e){setState({syncErr:"Ï†ÄÏû• Ïã§Ìå®: "+e.message});}
  setState({syncing:false});
}

/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
function tlog(){return S.dailyLogs[TODAY()]||{completed:{},bonusQuests:[]};}
function setTlog(fn){const n=fn(tlog());setState(s=>({dailyLogs:{...s.dailyLogs,[TODAY()]:n}}));}
function toggleQ(q){
  const done=!!tlog().completed?.[q.id];
  const pLv=getLv(S.profile.totalXP).level;
  const nXP=S.profile.totalXP+(done?-q.xp:q.xp);
  const nLv=getLv(nXP).level;
  setState(s=>({profile:{...s.profile,totalXP:nXP},popId:done?null:q.id}));
  setTlog(l=>{const nc={...l.completed,[q.id]:!done};if(done)delete nc[q.id];return{...l,completed:nc};});
  if(!done&&nLv>pLv)showToast(nLv);
  setTimeout(()=>setState({popId:null}),500);
  sh(done?{action:"removeLog",date:TODAY(),questId:q.id,isBonus:"false"}:{action:"logQuest",date:TODAY(),questId:q.id,questTitle:q.title,xp:q.xp,isBonus:"false"});
  sh({action:"updateXP",totalXP:nXP});
}
function toggleB(i){
  const b=tlog().bonusQuests[i];
  const nXP=S.profile.totalXP+(b.done?-b.xp:b.xp);
  const pLv=getLv(S.profile.totalXP).level;
  setState(s=>({profile:{...s.profile,totalXP:nXP}}));
  setTlog(l=>({...l,bonusQuests:l.bonusQuests.map((bq,j)=>j===i?{...bq,done:!bq.done}:bq)}));
  if(!b.done&&getLv(nXP).level>pLv)showToast(getLv(nXP).level);
  const bid=`b${i}-${b.title}`;
  sh(b.done?{action:"removeLog",date:TODAY(),questId:bid,isBonus:"true"}:{action:"logQuest",date:TODAY(),questId:bid,questTitle:b.title,xp:b.xp,isBonus:"true"});
  sh({action:"updateXP",totalXP:nXP});
}
function saveQ(q){setState({quests:q});sh({action:"saveQuests",quests:q});}
function saveR(r){setState({rewards:r});sh({action:"saveRewards",rewards:r});}
function claimR(i){const r=S.rewards[i];saveR(S.rewards.map((rr,j)=>j===i?{...rr,claimed:true}:rr));sh({action:"claimReward",level:r.level});}
function setTitle(t){S.activeTitle=t;localStorage.setItem(LS_TITLE,t);render();}

/* ‚îÄ‚îÄ DOM HELPERS ‚îÄ‚îÄ */
function el(tag,a,...c){
  const e=document.createElement(tag);
  for(const[k,v]of Object.entries(a||{})){
    if(k==="class")e.className=v;
    else if(k.startsWith("on"))e.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==="style"&&typeof v==="object")Object.assign(e.style,v);
    else e.setAttribute(k,v);
  }
  c.flat().forEach(c=>{if(c==null)return;e.appendChild(typeof c==="string"?document.createTextNode(c):c);});
  return e;
}
const d=(a,...c)=>el("div",a,...c);
const s=(a,...c)=>el("span",a,...c);
const b=(a,...c)=>el("button",a,...c);
const ip=a=>el("input",a);

/* ‚îÄ‚îÄ SVG CHARTS ‚îÄ‚îÄ */
function weekChart(){
  const days=[];
  for(let i=6;i>=0;i--){const dt=new Date();dt.setDate(dt.getDate()-i);dt.setTime(dt.getTime()+9*60*60*1000);
    const k=dt.toISOString().slice(0,10);const l=S.dailyLogs[k]||{completed:{},bonusQuests:[]};const aQ=S.quests.filter(q=>q.active);const dn=aQ.filter(q=>l.completed?.[q.id]).length+(l.bonusQuests||[]).filter(b=>b.done).length;const tot=aQ.length+(l.bonusQuests||[]).length;days.push({k,dn,tot,pct:tot?Math.round((dn/tot)*100):0,lbl:dt.toLocaleDateString("ko-KR",{weekday:"short"})});}
  const max=Math.max(...days.map(d=>d.pct),1);
  const W=420,H=140,pad=10;
  const pts=days.map((d,i)=>({x:pad+(i/(days.length-1))*(W-pad*2),y:H-pad-(d.pct/max)*(H-pad*2-10),...d}));
  const ns="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(ns,"svg");
  svg.setAttribute("viewBox",`0 0 ${W} ${H}`);svg.setAttribute("width","100%");svg.setAttribute("height","140");
  const defs=document.createElementNS(ns,"defs");
  const gr=document.createElementNS(ns,"linearGradient");gr.setAttribute("id","wcg");gr.setAttribute("x1","0");gr.setAttribute("y1","0");gr.setAttribute("x2","0");gr.setAttribute("y2","1");
  const st1=document.createElementNS(ns,"stop");st1.setAttribute("offset","0%");st1.setAttribute("stop-color","#F4A000");st1.setAttribute("stop-opacity","0.3");
  const st2=document.createElementNS(ns,"stop");st2.setAttribute("offset","100%");st2.setAttribute("stop-color","#F4A000");st2.setAttribute("stop-opacity","0");
  gr.appendChild(st1);gr.appendChild(st2);defs.appendChild(gr);svg.appendChild(defs);
  const fill=document.createElementNS(ns,"path");
  fill.setAttribute("d",pts.map((p,i)=>i===0?`M${p.x},${H}L${p.x},${p.y}`:`L${p.x},${p.y}`).join(" ")+`L${pts[pts.length-1].x},${H}Z`);
  fill.setAttribute("fill","url(#wcg)");svg.appendChild(fill);
  const line=document.createElementNS(ns,"path");
  line.setAttribute("d",pts.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(" "));
  line.setAttribute("fill","none");line.setAttribute("stroke","#F4A000");line.setAttribute("stroke-width","2");line.setAttribute("stroke-linecap","round");line.setAttribute("stroke-linejoin","round");
  svg.appendChild(line);
  pts.forEach(p=>{
    const isTd=p.k===TODAY();
    const c=document.createElementNS(ns,"circle");c.setAttribute("cx",p.x);c.setAttribute("cy",p.y);c.setAttribute("r",isTd?"5":"3");c.setAttribute("fill",p.pct===100?"#00B894":isTd?"#F4A000":"var(--bd)");c.setAttribute("stroke","var(--bg2)");c.setAttribute("stroke-width","2");svg.appendChild(c);
    const t=document.createElementNS(ns,"text");t.setAttribute("x",p.x);t.setAttribute("y",H-1);t.setAttribute("text-anchor","middle");t.setAttribute("font-size","8");t.setAttribute("fill","var(--tx3)");t.setAttribute("font-family","Barlow Condensed,sans-serif");t.textContent=p.lbl;svg.appendChild(t);
  });
  return svg;
}

function catDonut(){
  const log=tlog();
  const cats={};
  S.quests.filter(q=>q.active).forEach(q=>{if(!cats[q.category])cats[q.category]={tot:0,dn:0,color:CAT[q.category]?.color||"#888"};cats[q.category].tot++;if(log.completed?.[q.id])cats[q.category].dn++;});
  const ents=Object.entries(cats);
  if(!ents.length)return d({style:{color:"var(--tx3)",fontSize:"12px",textAlign:"center",padding:"16px 0"}},"Í∏∞Î°ù ÏóÜÏùå");
  const ns="http://www.w3.org/2000/svg",sz=150,r=58,cx=75,cy=75;
  const svg=document.createElementNS(ns,"svg");svg.setAttribute("viewBox","0 0 150 150");svg.setAttribute("width","150");svg.setAttribute("height","150");
  let ang=-90;
  const tot=ents.reduce((s,[,v])=>s+v.tot,0);
  ents.forEach(([,v])=>{
    const sl=(v.tot/tot)*360;const st=ang;const en=ang+sl;ang=en;
    const sr=st*Math.PI/180,er=en*Math.PI/180;
    const x1=cx+r*Math.cos(sr),y1=cy+r*Math.sin(sr),x2=cx+r*Math.cos(er),y2=cy+r*Math.sin(er);
    const p=document.createElementNS(ns,"path");
    p.setAttribute("d",`M${cx},${cy}L${x1},${y1}A${r},${r} 0 ${sl>180?1:0},1 ${x2},${y2}Z`);
    p.setAttribute("fill",v.color);p.setAttribute("opacity",v.tot>0?(0.3+0.7*(v.dn/v.tot)):0.3);
    svg.appendChild(p);
  });
  const h=document.createElementNS(ns,"circle");h.setAttribute("cx",cx);h.setAttribute("cy",cy);h.setAttribute("r","38");h.setAttribute("fill","var(--bg2)");svg.appendChild(h);
  const dnAll=ents.reduce((s,[,v])=>s+v.dn,0);
  const t1=document.createElementNS(ns,"text");t1.setAttribute("x",cx);t1.setAttribute("y",cy-3);t1.setAttribute("text-anchor","middle");t1.setAttribute("font-size","15");t1.setAttribute("font-weight","800");t1.setAttribute("font-family","Barlow Condensed,sans-serif");t1.setAttribute("fill","var(--tx)");t1.textContent=`${dnAll}/${tot}`;svg.appendChild(t1);
  const t2=document.createElementNS(ns,"text");t2.setAttribute("x",cx);t2.setAttribute("y",cy+13);t2.setAttribute("text-anchor","middle");t2.setAttribute("font-size","8");t2.setAttribute("font-family","Barlow Condensed,sans-serif");t2.setAttribute("fill","var(--tx3)");t2.textContent="ÏôÑÎ£å";svg.appendChild(t2);
  return svg;
}

/* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
function renderSetup(){
  const ui=ip({class:"inp",placeholder:"https://script.google.com/macros/s/.../exec",value:S.sheetsUrl,style:{flex:"1"}});
  ui.addEventListener("input",e=>S.sheetsUrl=e.target.value);
  ui.addEventListener("keydown",e=>{if(e.key==="Enter")loadAll();});
  return d({class:"setup"},
    d({style:{textAlign:"center",marginBottom:"8px"}},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"36px",letterSpacing:"5px"},class:"grad-text"},"QUEST LOG"),
      d({style:{fontSize:"12px",color:"var(--tx3)",letterSpacing:"2px",marginTop:"6px"}},"PERSONAL DAILY MISSION SYSTEM")
    ),
    ...[
      {n:"01",t:"Google Sheets ÏÉùÏÑ±",body:"sheets.new ÏóêÏÑú ÏÉà Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Î•º ÎßåÎìúÏÑ∏Ïöî."},
      {n:"02",t:"Apps Script ÏÑ§Ï†ï",body:"ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû® ‚Üí Apps Script ‚Üí Code.gs Î∂ôÏó¨ÎÑ£Í∏∞ ‚Üí Ï†ÄÏû•\n‚öîÔ∏è ÌÄòÏä§Ìä∏ ÏãúÏä§ÌÖú Î©îÎâ¥ ‚Üí Ï¥àÍ∏∞ ÏãúÌä∏ ÏÑ§Ï†ï Ïã§Ìñâ"},
      {n:"03",t:"Ïõπ Ïï± Î∞∞Ìè¨",body:"Î∞∞Ìè¨ ‚Üí ÏÉà Î∞∞Ìè¨ ‚Üí Ïú†Ìòï: Ïõπ Ïï±\nÏï°ÏÑ∏Ïä§: Î™®Îì† ÏÇ¨Ïö©Ïûê ‚Üí Î∞∞Ìè¨ ÌõÑ URL Î≥µÏÇ¨"},
    ].map(s=>d({class:"step-box"},d({style:{display:"flex",gap:"14px",alignItems:"flex-start"}},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"28px",lineHeight:"1",flexShrink:"0"},class:"grad-text"},s.n),
      d({},d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700",fontSize:"14px",letterSpacing:"1px",color:"var(--tx)",marginBottom:"6px"}},s.t),
        d({style:{fontSize:"12px",color:"var(--tx2)",lineHeight:"1.7",whiteSpace:"pre-line"}},s.body))
    ))),
    d({class:"step-box",style:{maxWidth:"520px"}},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700",fontSize:"13px",letterSpacing:"1px",color:"var(--or)",marginBottom:"10px"}},"04 ‚Äî Ïõπ Ïï± URL ÏûÖÎ†•"),
      d({style:{display:"flex",gap:"8px"}},ui,b({class:"btn btn-ow",style:{flexShrink:"0"},onclick:loadAll},S.loading?el("span",{class:"spin"}):"Ïó∞Í≤∞")),
      S.syncErr?d({style:{marginTop:"10px",fontSize:"12px",color:"var(--rd)"}},S.syncErr):null
    )
  );
}

/* ‚îÄ‚îÄ TODAY ‚îÄ‚îÄ */
function renderToday(){
  const log=tlog(),aQ=S.quests.filter(q=>q.active);
  const dFx=aQ.filter(q=>log.completed?.[q.id]),bonQ=log.bonusQuests||[],dBn=bonQ.filter(b=>b.done);
  const todXP=dFx.reduce((s,q)=>s+q.xp,0)+dBn.reduce((s,b)=>s+b.xp,0);
  const totT=aQ.length+bonQ.length,totD=dFx.length+dBn.length,pct=totT?Math.round((totD/totT)*100):0;
  const f=document.createDocumentFragment();

  f.appendChild(d({style:{display:"flex",gap:"8px",marginBottom:"16px"}},
    ...[{l:"ÏôÑÎ£å",v:`${totD}/${totT}`,c:"var(--bl)"},{l:"Ïò§Îäò XP",v:`+${todXP}`,c:"var(--or)"},{l:"Îã¨ÏÑ±Î•†",v:`${pct}%`,c:pct===100?"var(--gr)":"var(--tx2)"}]
    .map(st=>d({class:"stat-c"},d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontSize:"9px",letterSpacing:"2px",color:"var(--tx3)",marginBottom:"5px"}},st.l),d({class:"snum",style:{color:st.c}},st.v)))
  ));

  f.appendChild(d({style:{marginBottom:"20px"}},
    d({style:{display:"flex",justifyContent:"space-between",marginBottom:"5px"}},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontSize:"10px",letterSpacing:"2px",color:"var(--tx3)"}},"DAY PROGRESS"),
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontSize:"10px",color:pct===100?"var(--gr)":"var(--or)"}},`${pct}%`)
    ),
    d({style:{height:"6px",background:"var(--bg3)",borderRadius:"3px",overflow:"hidden"}},
      d({class:"xpf",style:{width:`${pct}%`,borderRadius:"3px"}})
    )
  ));

  f.appendChild(d({class:"slbl"},"Í≥†Ï†ï ÎØ∏ÏÖò"));
  aQ.forEach(q=>{
    const done=!!log.completed?.[q.id],cat=CAT[q.category];
    const row=d({class:`qrow${done?" done":""}${S.popId===q.id?" pop":""}`,onclick:()=>toggleQ(q)},
      d({class:"qi"},
        d({class:`chk${done?" on":""}`,style:{borderColor:done?"transparent":(cat?.color||"var(--or)")+"55"}},done?"‚úì":""),
        d({style:{width:"3px",height:"28px",background:cat?.color||"var(--or)",borderRadius:"2px",flexShrink:"0",opacity:done?"0.2":"1",boxShadow:done?"none":`0 0 6px ${cat?.color||"var(--or)"}55`}}),
        d({style:{flex:"1",minWidth:"0"}},
          d({class:"qt",style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"600",fontSize:"15px",color:done?"var(--tx3)":"var(--tx)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},`${q.emoji} ${q.title}`),
          d({style:{fontSize:"10px",color:cat?.color||"var(--or)",opacity:done?"0.4":"0.7",marginTop:"2px"}},q.category)
        ),
        d({style:{textAlign:"right",flexShrink:"0"}},
          d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"16px",color:done?"var(--tx3)":"var(--or)"}},`+${q.xp}`),
          d({style:{fontSize:"9px",letterSpacing:"1px",color:"var(--tx3)"}},"XP")
        )
      )
    );
    f.appendChild(row);
  });

  if(bonQ.length>0){
    f.appendChild(d({class:"div"},el("span",{class:"divl"},"Ï∂îÍ∞Ä ÎØ∏ÏÖò")));
    bonQ.forEach((bq,i)=>{
      f.appendChild(d({class:`qrow${bq.done?" done":""}`,onclick:()=>toggleB(i)},
        d({class:"qi"},
          d({class:`chk${bq.done?" on":""}`},bq.done?"‚úì":""),
          d({style:{width:"3px",height:"28px",background:"#E84460",borderRadius:"2px",flexShrink:"0",opacity:bq.done?"0.2":"1"}}),
          d({style:{flex:"1"}},
            d({class:"qt",style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"600",fontSize:"15px",color:bq.done?"var(--tx3)":"var(--tx)"}},`‚ö° ${bq.title}`),
            d({style:{fontSize:"10px",color:"#E84460",opacity:bq.done?"0.4":"0.7",marginTop:"2px"}},"Ïª§Ïä§ÌÖÄ")
          ),
          d({style:{textAlign:"right",flexShrink:"0"}},
            d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"16px",color:bq.done?"var(--tx3)":"var(--or)"}},`+${bq.xp}`),
            d({style:{fontSize:"9px",letterSpacing:"1px",color:"var(--tx3)"}},"XP")
          )
        )
      ));
    });
  }

  f.appendChild(b({class:"btn btn-gh",style:{width:"100%",marginTop:"12px"},onclick:()=>setState({modal:"addBonus",form:{title:"",xp:50}})},
    "+ ADD BONUS MISSION"));
  return f;
}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
function renderHistory(){
  const f=document.createDocumentFragment();
  f.appendChild(d({class:"slbl"},"Ï†ÑÌà¨ Í∏∞Î°ù"));
  const dates=Object.keys(S.dailyLogs).sort((a,b)=>b.localeCompare(a));
  if(!dates.length){f.appendChild(d({style:{textAlign:"center",color:"var(--tx3)",padding:"40px 0",fontFamily:"'Barlow Condensed',sans-serif",fontSize:"14px",letterSpacing:"2px"}},"NO RECORDS FOUND"));return f;}
  const aQ=S.quests.filter(q=>q.active);
  dates.forEach(date=>{
    const log=S.dailyLogs[date],df=aQ.filter(q=>log.completed?.[q.id]),db=(log.bonusQuests||[]).filter(b=>b.done);
    const tot=aQ.length+(log.bonusQuests||[]).length,dn=df.length+db.length;
    const xpE=df.reduce((s,q)=>s+q.xp,0)+db.reduce((s,b)=>s+b.xp,0);
    const p2=tot?Math.round((dn/tot)*100):0,isTd=date===TODAY();
    let dtStr=date;
    try{
      // date is YYYY-MM-DD, parse safely in KST
      const[y,mo,dd]=date.split("-").map(Number);
      const dt=new Date(y,mo-1,dd);
      dtStr=dt.toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"});
    }catch(e){}
    f.appendChild(d({class:"hcard"},
      d({style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"8px"}},
        d({},
          d({style:{display:"flex",alignItems:"center",gap:"6px",flexWrap:"wrap",marginBottom:"3px"}},
            el("span",{style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700",fontSize:"14px",color:"var(--tx)"}},dtStr),
            isTd?el("span",{class:"bdg bdg-or"},"TODAY"):null,
            p2===100?el("span",{class:"bdg bdg-gr"},"‚úì PERFECT"):null
          ),
          d({style:{fontSize:"11px",color:"var(--tx3)"}},`${dn}/${tot} missions`)
        ),
        d({style:{textAlign:"right"}},
          d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"16px",color:"var(--or)"}},`+${xpE} XP`),
          d({style:{fontSize:"11px",color:p2===100?"var(--gr)":"var(--tx3)",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700"}},`${p2}%`)
        )
      ),
      d({style:{height:"4px",background:"var(--bg3)",borderRadius:"2px",overflow:"hidden",marginBottom:"9px"}},
        d({style:{height:"100%",width:`${p2}%`,background:p2===100?"linear-gradient(90deg,#00B894,#00D4AA)":"linear-gradient(90deg,#FF6B00,#F4A000)",borderRadius:"2px",transition:"width .5s"}})
      ),
      d({style:{display:"flex",flexWrap:"wrap"}},
        ...df.map(q=>el("span",{class:"tag",style:{background:"var(--ors)",color:"var(--or)",border:"1px solid var(--bd)"}},`${q.emoji} ${q.title}`)),
        ...db.map(bq=>el("span",{class:"tag",style:{background:"rgba(232,68,96,.07)",color:"#E84460",border:"1px solid rgba(232,68,96,.18)"}},`‚ö° ${bq.title}`))
      )
    ));
  });
  return f;
}

/* ‚îÄ‚îÄ QUESTS PANEL ‚îÄ‚îÄ */
function renderQuests(){
  const f=document.createDocumentFragment();
  f.appendChild(d({style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}},
    d({class:"slbl",style:{marginBottom:"0"}},"ÎØ∏ÏÖò Í¥ÄÎ¶¨"),
    b({class:"btn btn-ow",style:{padding:"7px 14px",fontSize:"11px"},onclick:()=>setState({modal:"addQ",form:{title:"",category:"ÎßàÏù∏Îìú",emoji:"‚≠ê",xp:50}})},"+ ÎØ∏ÏÖò Ï∂îÍ∞Ä")
  ));
  S.quests.forEach((q,idx)=>{
    const cat=CAT[q.category];
    f.appendChild(d({style:{display:"flex",alignItems:"center",gap:"10px",padding:"12px 15px",background:"var(--panel)",border:`1px solid ${q.active?"var(--bd2)":"var(--bd3)"}`,borderRadius:"var(--rs)",boxShadow:"var(--sh)",marginBottom:"7px",opacity:q.active?"1":"0.45",transition:"opacity .2s"}},
      d({style:{width:"3px",height:"32px",background:cat?.color||"var(--or)",borderRadius:"2px",flexShrink:"0"}}),
      d({style:{fontSize:"18px"}},q.emoji),
      d({style:{flex:"1",minWidth:"0"}},
        d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"600",fontSize:"14px",color:"var(--tx)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},q.title),
        d({style:{fontSize:"11px",display:"flex",gap:"7px",marginTop:"2px"}},
          el("span",{style:{color:cat?.color||"var(--or)"}},q.category),
          el("span",{style:{color:"var(--tx3)"}},"¬∑"),
          el("span",{style:{color:"var(--or)",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700"}},`${q.xp} XP`)
        )
      ),
      d({style:{display:"flex",gap:"5px",flexShrink:"0"}},
        b({class:"btn btn-gh",style:{padding:"5px 11px",fontSize:"11px"},onclick:()=>setState({modal:"editQ",form:{...q,idx}})},"Ìé∏Ïßë"),
        b({class:"btn btn-gh",style:{padding:"5px 11px",fontSize:"11px",color:q.active?"var(--rd)":"var(--gr)"},onclick:()=>saveQ(S.quests.map((qq,i)=>i===idx?{...qq,active:!qq.active}:qq))},q.active?"OFF":"ON")
      )
    ));
  });
  return f;
}

/* ‚îÄ‚îÄ REWARDS PANEL ‚îÄ‚îÄ */
function renderRewards(){
  const lv=getLv(S.profile.totalXP);
  const f=document.createDocumentFragment();
  f.appendChild(d({style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}},
    d({class:"slbl",style:{marginBottom:"0"}},"Î†àÎ≤® Î≥¥ÏÉÅ"),
    b({class:"btn btn-ow",style:{padding:"7px 14px",fontSize:"11px"},onclick:()=>setState({modal:"addR",form:{level:lv.level+1,type:"real",value:""}})},"+ Î≥¥ÏÉÅ Ï∂îÍ∞Ä")
  ));

  // Active title selector
  const titles=S.rewards.filter(r=>r.type==="title"&&r.claimed).map(r=>r.value);
  if(titles.length>0){
    f.appendChild(d({class:"slbl",style:{marginBottom:"8px"}},"ÌôúÏÑ± Ïπ≠Ìò∏"));
    f.appendChild(d({style:{display:"flex",flexWrap:"wrap",gap:"7px",marginBottom:"18px"}},
      ...["ÏóÜÏùå",...titles].map(t=>{
        const isActive=S.activeTitle===(t==="ÏóÜÏùå"?"":t);
        return b({style:{padding:"7px 14px",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700",fontSize:"12px",letterSpacing:".5px",background:isActive?"linear-gradient(135deg,#C47800,#F4A000)":"var(--panel)",color:isActive?"#fff":"var(--tx2)",border:`1px solid ${isActive?"transparent":"var(--bd2)"}`,borderRadius:"20px",cursor:"pointer",transition:"all .2s",boxShadow:isActive?"0 4px 12px rgba(244,160,0,.3)":"var(--sh)"},onclick:()=>setTitle(t==="ÏóÜÏùå"?"":t)},t);
      })
    ));
  }

  // Profile summary card
  f.appendChild(d({style:{background:"linear-gradient(135deg,var(--ors),rgba(255,107,0,.05))",border:"1px solid var(--bd)",borderRadius:"var(--r)",padding:"14px 16px",marginBottom:"16px",display:"flex",justifyContent:"space-between",alignItems:"center"}},
    d({},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"24px"},class:"grad-text"},`LV.${lv.level}`),
      d({style:{fontSize:"12px",color:"var(--tx2)",marginTop:"1px"}},S.activeTitle||"Ïπ≠Ìò∏ ÎØ∏ÏÑ§Ï†ï")
    ),
    d({style:{textAlign:"right"}},
      d({style:{fontSize:"11px",color:"var(--tx3)",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},"ÎàÑÏ†Å XP"),
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"20px",color:"var(--or)"}},S.profile.totalXP.toLocaleString())
    )
  ));

  [...S.rewards].sort((a,b)=>a.level-b.level).forEach((r,si)=>{
    const oi=S.rewards.indexOf(r),isU=lv.level>=r.level;
    const cls=r.claimed?"claimed":isU?"unlocked":"locked";
    f.appendChild(d({class:`rwcard ${cls}`},
      d({class:"hex",style:{width:"38px",height:"38px",flexShrink:"0",background:r.claimed?"rgba(0,184,148,.14)":isU?"var(--ors)":"var(--bg3)",fontSize:"17px"}},
        r.claimed?"‚úÖ":isU?"üéÅ":"üîí"),
      d({style:{flex:"1",minWidth:"0"}},
        d({style:{display:"flex",gap:"6px",marginBottom:"3px",alignItems:"center",flexWrap:"wrap"}},
          el("span",{style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"12px",color:isU?"var(--or)":"var(--tx3)"}},`LV.${r.level}`),
          el("span",{class:`bdg ${r.type==="title"?"bdg-bl":"bdg-or"}`,style:{fontSize:"9px"}},r.type==="title"?"TITLE":"REAL")
        ),
        d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontSize:"13px",fontWeight:r.claimed?"400":"600",color:r.claimed?"var(--gr)":isU?"var(--tx)":"var(--tx3)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.value)
      ),
      d({style:{display:"flex",flexDirection:"column",gap:"5px",flexShrink:"0"}},
        isU&&!r.claimed?b({class:"btn btn-ow",style:{padding:"5px 12px",fontSize:"11px"},onclick:()=>claimR(oi)},"ÏàòÎ†π"):null,
        b({class:"btn btn-gh",style:{padding:"5px 12px",fontSize:"11px"},onclick:()=>setState({modal:"editR",form:{...r,idx:oi}})},"Ìé∏Ïßë")
      )
    ));
  });
  f.appendChild(b({class:"btn btn-rd",style:{width:"100%",marginTop:"14px",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1.5px",fontSize:"12px"},
    onclick:()=>{if(confirm("Ïó∞Îèô Ìï¥Ï†ú ÌõÑ Ï¥àÍ∏∞ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.")){localStorage.removeItem(LS_URL);setState({view:"setup",sheetsUrl:"",syncErr:"",loading:false});}}},"DISCONNECT SHEETS"));
  return f;
}

/* ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ */
function renderRight(){
  const lv=getLv(S.profile.totalXP);
  const log=tlog(),aQ=S.quests.filter(q=>q.active);
  const f=document.createDocumentFragment();

  // Week chart
  f.appendChild(d({class:"slbl"},"Ï£ºÍ∞Ñ ÌôúÎèô"));
  f.appendChild(d({class:"card",style:{marginBottom:"14px",padding:"16px 14px"}},weekChart()));

  // Category donut + bars
  f.appendChild(d({class:"slbl"},"Ïπ¥ÌÖåÍ≥†Î¶¨ ÌòÑÌô©"));
  f.appendChild(d({class:"card",style:{marginBottom:"14px",padding:"16px"}},
    d({style:{display:"flex",gap:"14px",alignItems:"center"}},
      catDonut(),
      d({style:{flex:"1",display:"flex",flexDirection:"column",gap:"9px"}},
        ...Object.entries(CAT).map(([nm,{color}])=>{
          const qs=aQ.filter(q=>q.category===nm);if(!qs.length)return null;
          const dn=qs.filter(q=>log.completed?.[q.id]).length,p2=Math.round((dn/qs.length)*100);
          return d({},
            d({style:{display:"flex",justifyContent:"space-between",marginBottom:"3px"}},
              el("span",{style:{fontSize:"10px",color:"var(--tx2)",fontFamily:"'Barlow Condensed',sans-serif"}},nm),
              el("span",{style:{fontSize:"10px",color,fontWeight:"700",fontFamily:"'Barlow Condensed',sans-serif"}},`${p2}%`)
            ),
            d({style:{height:"4px",background:"var(--bg3)",borderRadius:"2px",overflow:"hidden"}},
              d({style:{height:"100%",width:`${p2}%`,background:color,borderRadius:"2px",transition:"width .6s ease"}})
            )
          );
        }).filter(Boolean)
      )
    )
  ));

  // Stats
  f.appendChild(d({class:"slbl"},"ÌÜµÍ≥Ñ"));
  const allDn=Object.values(S.dailyLogs).reduce((s,l)=>{
    return s+aQ.filter(q=>l.completed?.[q.id]).length+(l.bonusQuests||[]).filter(b=>b.done).length;
  },0);
  f.appendChild(d({class:"card",style:{marginBottom:"14px",padding:"16px"}},
    d({style:{display:"flex",flexDirection:"column",gap:"11px"}},
      ...[
        {l:"Í∏∞Î°ùÎêú ÎÇ†Ïßú",v:`${Object.keys(S.dailyLogs).length}Ïùº`},
        {l:"Ï¥ù ÏôÑÎ£å ÎØ∏ÏÖò",v:`${allDn}Í∞ú`},
        {l:"Îã§Ïùå Î†àÎ≤®ÍπåÏßÄ",v:`${(lv.need-lv.cur).toLocaleString()} XP`},
      ].map(({l,v})=>d({style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
        el("span",{style:{fontSize:"12px",color:"var(--tx2)"}},l),
        el("span",{style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"14px",color:"var(--tx)"}},v)
      ))
    )
  ));

  // Unclaimed
  const uncl=S.rewards.filter(r=>!r.claimed&&lv.level>=r.level);
  if(uncl.length>0){
    f.appendChild(d({class:"slbl"},"ÎØ∏ÏàòÎ†π Î≥¥ÏÉÅ"));
    f.appendChild(d({style:{background:"var(--ors)",border:"1px solid var(--bd)",borderRadius:"var(--r)",padding:"14px",animation:"gp 2s ease-in-out infinite"}},
      ...uncl.map((r,i)=>d({style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:i<uncl.length-1?"10px":"0"}},
        el("span",{style:{fontSize:"20px"}},"üéÅ"),
        d({style:{flex:"1"}},
          d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700",fontSize:"12px",color:"var(--or)"}},`LV.${r.level} Îã¨ÏÑ±!`),
          d({style:{fontSize:"12px",color:"var(--tx)"}},r.value)
        ),
        b({class:"btn btn-ow",style:{padding:"5px 12px",fontSize:"11px"},onclick:()=>claimR(S.rewards.indexOf(r))},"ÏàòÎ†π")
      ))
    ));
  }
  return f;
}

/* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */
function renderLeft(lv){
  const NAV=[["today","‚öîÔ∏è","Ïò§Îäò"],["history","üìÖ","Í∏∞Î°ù"],["quests","‚öôÔ∏è","ÎØ∏ÏÖò"],["rewards","üèÜ","Î≥¥ÏÉÅ"]];
  return d({class:"sl"},
    // Logo + toggle
    d({style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"4px"}},
      d({},
        d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"20px",letterSpacing:"3px"},class:"grad-text"},"QUEST LOG"),
        d({style:{fontSize:"9px",color:"var(--tx3)",letterSpacing:"1.5px",marginTop:"2px",display:"flex",alignItems:"center"}},
          el("span",{class:"ping"}),S.syncing?"SYNCING...":"CONNECTED")
      ),
      d({class:`tog${S.theme==="dark"?" dk":""}`,onclick:toggleTheme,title:"ÌÖåÎßà Ï†ÑÌôò"})
    ),

    // Player card
    d({style:{marginTop:"16px",background:"linear-gradient(135deg,var(--ors),rgba(255,107,0,.05))",border:"1px solid var(--bd)",borderRadius:"var(--r)",padding:"14px",marginBottom:"4px"}},
      d({style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"12px"}},
        d({class:"hex",style:{width:"46px",height:"46px",flexShrink:"0",background:"linear-gradient(135deg,#C47800,#F4A000,#FFD700)",fontSize:"20px",color:"#fff",boxShadow:"0 4px 16px rgba(244,160,0,.35)"}},"‚öî"),
        d({style:{flex:"1"}},
          d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"20px"},class:"grad-text"},`LV.${lv.level}`),
          d({style:{fontSize:"11px",color:"var(--tx2)",marginTop:"1px"}},S.activeTitle||"Ïπ≠Ìò∏ ÏóÜÏùå")
        )
      ),
      d({style:{display:"flex",justifyContent:"space-between",marginBottom:"5px"}},
        el("span",{style:{fontSize:"9px",color:"var(--tx3)",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},"EXP"),
        el("span",{style:{fontSize:"9px",color:"var(--or)",fontFamily:"'Barlow Condensed',sans-serif"}},`${lv.cur.toLocaleString()} / ${lv.need.toLocaleString()}`)
      ),
      d({style:{height:"7px",background:"var(--bg3)",borderRadius:"4px",overflow:"hidden"}},
        d({class:"xpf",style:{width:`${lv.pct}%`,borderRadius:"4px"}})
      )
    ),

    // Nav
    d({style:{display:"flex",flexDirection:"column",gap:"3px",marginTop:"14px",flex:"1"}},
      ...NAV.map(([k,ic,l])=>b({class:`snav${S.tab===k?" on":""}`,onclick:()=>setState({tab:k})},el("span",{},ic),l))
    ),

    // Date
    d({style:{marginTop:"auto",paddingTop:"16px",fontSize:"11px",color:"var(--tx3)",letterSpacing:"1px",fontFamily:"'Barlow Condensed',sans-serif"}},
      new Date().toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric",weekday:"long"})
    )
  );
}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
function renderModal(){
  const{modal,form}=S;if(!modal)return null;
  const close=()=>setState({modal:null,form:{}});
  let ttl,body,acts;

  if(modal==="addBonus"){
    const ti=ip({class:"inp",placeholder:"ÎØ∏ÏÖò ÎÇ¥Ïö©",value:form.title||""});
    ti.addEventListener("input",e=>S.form.title=e.target.value);
    const xl=el("span",{style:{color:"var(--or)",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700"}},form.xp||50);
    const xr=ip({type:"range",min:"10",max:"200",step:"10",value:form.xp||50});
    xr.addEventListener("input",e=>{S.form.xp=Number(e.target.value);xl.textContent=e.target.value;});
    ttl="+ BONUS MISSION";
    body=[ti,d({style:{marginTop:"8px"}},d({style:{fontSize:"11px",color:"var(--tx3)",marginBottom:"6px",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},"XP REWARD: ",xl),xr)];
    acts=[b({class:"btn btn-ow",style:{flex:"1"},onclick:()=>{if(!S.form.title?.trim())return;setTlog(l=>({...l,bonusQuests:[...(l.bonusQuests||[]),{title:S.form.title,xp:S.form.xp||50,done:false}]}));close();}},"Ï∂îÍ∞Ä"),b({class:"btn btn-gh",onclick:close},"Ï∑®ÏÜå")];
  }
  else if(modal==="addQ"||modal==="editQ"){
    const ei=ip({class:"inp",style:{width:"52px",flex:"none",textAlign:"center"},placeholder:"üåü",value:form.emoji||""});ei.addEventListener("input",e=>S.form.emoji=e.target.value);
    const ti=ip({class:"inp",placeholder:"ÎØ∏ÏÖò Ïù¥Î¶Ñ",value:form.title||""});ti.addEventListener("input",e=>S.form.title=e.target.value);
    const cs=el("select",{class:"inp"},
      ...["ÎßàÏù∏Îìú","Î∞îÎîî","ÏÑ±Ïû•","Ïª§Ïä§ÌÖÄ"].map(c=>{const o=el("option",{},c);if(c===form.category)o.selected=true;return o;}));
    cs.addEventListener("change",e=>S.form.category=e.target.value);
    const xl=el("span",{style:{color:"var(--or)",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"700"}},form.xp||50);
    const xr=ip({type:"range",min:"10",max:"300",step:"10",value:form.xp||50});xr.addEventListener("input",e=>{S.form.xp=Number(e.target.value);xl.textContent=e.target.value;});
    ttl=modal==="addQ"?"+ ADD MISSION":"EDIT MISSION";
    body=[d({style:{display:"flex",gap:"8px"}},ei,ti),cs,d({style:{marginTop:"4px"}},d({style:{fontSize:"11px",color:"var(--tx3)",marginBottom:"6px",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},"XP REWARD: ",xl),xr)];
    acts=[
      b({class:"btn btn-ow",style:{flex:"1"},onclick:()=>{if(!S.form.title?.trim())return;const nq=modal==="addQ"?[...S.quests,{id:`q${Date.now()}`,title:S.form.title,category:S.form.category||"ÎßàÏù∏Îìú",emoji:S.form.emoji||"‚≠ê",xp:S.form.xp||50,active:true}]:S.quests.map((q,i)=>i===form.idx?{...q,title:S.form.title,category:S.form.category||q.category,emoji:S.form.emoji||q.emoji,xp:S.form.xp||q.xp}:q);saveQ(nq);close();}},"Ï†ÄÏû•"),
      modal==="editQ"?b({class:"btn btn-rd",onclick:()=>{saveQ(S.quests.filter((_,i)=>i!==form.idx));close();}},"ÏÇ≠Ï†ú"):null,
      b({class:"btn btn-gh",onclick:close},"Ï∑®ÏÜå")
    ];
  }
  else if(modal==="addR"||modal==="editR"){
    const ll=el("span",{style:{color:"var(--or)",fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800"}},`LV.${form.level||1}`);
    const lr=ip({type:"range",min:"1",max:"50",value:form.level||1});lr.addEventListener("input",e=>{S.form.level=Number(e.target.value);ll.textContent=`LV.${e.target.value}`;});
    const ts=el("select",{class:"inp"},...[["real","ÌòÑÏã§ Î≥¥ÏÉÅ"],["title","Ïï± ÎÇ¥ Ïπ≠Ìò∏"]].map(([v,l])=>{const o=el("option",{value:v},l);if(v===form.type)o.selected=true;return o;}));
    ts.addEventListener("change",e=>S.form.type=e.target.value);
    const vi=ip({class:"inp",placeholder:form.type==="title"?"Ïòà: üî• Î∂àÍΩÉ Ï†ÑÏÇ¨":"Ïòà: ÏπòÌÇ® ÏÇ¨Î®πÍ∏∞ üçó",value:form.value||""});vi.addEventListener("input",e=>S.form.value=e.target.value);
    ttl=modal==="addR"?"+ ADD REWARD":"EDIT REWARD";
    body=[d({},d({style:{fontSize:"11px",color:"var(--tx3)",marginBottom:"6px",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},"TARGET LEVEL: ",ll),lr),ts,vi];
    acts=[
      b({class:"btn btn-ow",style:{flex:"1"},onclick:()=>{if(!S.form.value?.trim())return;const nr=modal==="addR"?[...S.rewards,{level:S.form.level||1,type:S.form.type||"real",value:S.form.value,claimed:false}]:S.rewards.map((r,i)=>i===form.idx?{...r,level:S.form.level||r.level,type:S.form.type||r.type,value:S.form.value}:r);saveR(nr);close();}},"Ï†ÄÏû•"),
      modal==="editR"?b({class:"btn btn-rd",onclick:()=>{saveR(S.rewards.filter((_,i)=>i!==form.idx));close();}},"ÏÇ≠Ï†ú"):null,
      b({class:"btn btn-gh",onclick:close},"Ï∑®ÏÜå")
    ];
  }

  const overlay=d({class:"mbg",onclick:e=>{if(e.target===overlay)close();}},
    d({class:"modal"},
      d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"16px",letterSpacing:"2px",color:"var(--or)",marginBottom:"20px"}},ttl),
      d({style:{display:"flex",flexDirection:"column",gap:"10px",marginBottom:"18px"}},...body.filter(Boolean)),
      d({style:{display:"flex",gap:"8px"}},...acts.filter(Boolean))
    )
  );
  return overlay;
}

/* ‚îÄ‚îÄ MAIN RENDER ‚îÄ‚îÄ */
function render(){
  const root=document.getElementById("app");root.innerHTML="";
  if(S.view==="setup"||S.loading){
    if(S.loading)root.appendChild(d({style:{minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"16px",background:"var(--bg)"}},d({class:"spin",style:{width:"36px",height:"36px",borderWidth:"3px"}}),d({style:{fontFamily:"'Barlow Condensed',sans-serif",fontSize:"13px",letterSpacing:"3px",color:"var(--or)"}},"CONNECTING...")));
    else root.appendChild(renderSetup());
    return;
  }

  const lv=getLv(S.profile.totalXP);
  const NAV=[["today","‚öîÔ∏è","Ïò§Îäò"],["history","üìÖ","Í∏∞Î°ù"],["quests","‚öôÔ∏è","ÎØ∏ÏÖò"],["rewards","üèÜ","Î≥¥ÏÉÅ"]];
  const layout=d({class:"layout"});

  // Left sidebar
  layout.appendChild(renderLeft(lv));

  // Main column
  const mc=d({class:"mc"});

  // Mobile header
  const mhd=d({class:"mob-head"},
    d({style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}},
      d({class:"grad-text",style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"18px",letterSpacing:"3px"}},"QUEST LOG"),
      d({style:{display:"flex",alignItems:"center",gap:"10px"}},
        d({class:`tog${S.theme==="dark"?" dk":""}`,onclick:toggleTheme}),
        d({class:"grad-text",style:{fontFamily:"'Barlow Condensed',sans-serif",fontWeight:"800",fontSize:"17px"}},`LV.${lv.level}`)
      )
    ),
    d({style:{height:"5px",background:"var(--bg3)",borderRadius:"3px",overflow:"hidden"}},d({class:"xpf",style:{width:`${lv.pct}%`,borderRadius:"3px"}})),
    d({style:{display:"flex",justifyContent:"space-between",marginTop:"3px"}},
      el("span",{style:{fontSize:"9px",color:"var(--tx3)",fontFamily:"'Barlow Condensed',sans-serif",letterSpacing:"1px"}},S.activeTitle||"Ïπ≠Ìò∏ ÏóÜÏùå"),
      el("span",{style:{fontSize:"9px",color:"var(--tx3)",fontFamily:"'Barlow Condensed',sans-serif"}},`${lv.cur}/${lv.need} XP`)
    )
  );
  mc.appendChild(mhd);

  if(S.syncErr)mc.appendChild(d({class:"errbar"},el("span",{},S.syncErr),b({style:{background:"none",border:"none",color:"var(--rd)",cursor:"pointer",fontSize:"16px"},onclick:()=>setState({syncErr:""})},"‚úï")));

  const panels={today:renderToday,history:renderHistory,quests:renderQuests,rewards:renderRewards};
  const pf=panels[S.tab]();
  if(pf instanceof DocumentFragment||pf instanceof HTMLElement)mc.appendChild(pf);
  layout.appendChild(mc);

  // Right sidebar
  const rsd=d({class:"sr"});
  const rf=renderRight();
  if(rf instanceof DocumentFragment||rf instanceof HTMLElement)rsd.appendChild(rf);
  layout.appendChild(rsd);

  root.appendChild(layout);

  // Mobile bottom nav
  root.appendChild(d({class:"mob-nav"},
    ...NAV.map(([k,ic,l])=>b({class:`mtab${S.tab===k?" on":""}`,onclick:()=>setState({tab:k})},
      d({style:{fontSize:"17px",marginBottom:"1px"}},ic),d({},l)
    ))
  ));

  // Modal
  const m=renderModal();if(m)root.appendChild(m);
}

/* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ */
S.sheetsUrl?loadAll():render();
</script>
</body>
</html>
